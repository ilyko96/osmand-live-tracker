<!DOCTYPE html>
<html lang="en">
	<head>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.2.1/css/ol.css" type="text/css">
		<style>
			.map {
				height: 600px;
				width: 100%;
			}
		</style>
		<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.2.1/build/ol.js"></script>
		<script src="util.js"></script>
		<title>v2.0</title>
	</head>
<body>
	<h2>Track my bike</h2>
	<h4>
		<div>Time at marker position: <span id="time_at_marker">unknown</span></div>
		<div>Speed at marker position: <span id="speed_at_marker">unknown</span></div>
		<div style="color: gray;">Last refresh: <span id="last_refresh">unknown</span></div>
	</h4>
	<select id="refresh_interval">
		<option value="-1" selected>No refresh</option>
		<option value="5000">5s</option>
		<option value="30000">30s</option>
		<option value="60000">1m</option>
		<option value="120000">2m</option>
		<option value="300000">5m</option>
	</select>
	<button id="update_btn">Manual update</button>
	<div id="map" class="map"></div>
	<script type="text/javascript">
		const URL_GETPOINTS = 'http://batukah.000webhostapp.com/osholm/v2.0/getPoints.php';

		var waypoints = []; // Originally downloaded JSON
		var coords = []; // lon/lat array for showing track on map
		var projectFunction = ol.proj.getTransform('EPSG:4326', 'EPSG:3857');

		var sourceTrack = new ol.source.Vector({}); // source for track
		var sourceMarker = new ol.source.Vector({}); // source for marker
		var trackLine = new ol.geom.LineString([]); // ol.geom.LineString instance for track
		var markerPoint = new ol.geom.Point([]); // ol.geom.Point instance for marker

		sourceTrack.addFeature(new ol.Feature(trackLine));
		sourceMarker.addFeature(new ol.Feature({geometry: markerPoint}));

		var updateWaypoints = function(centerTrack=false) {
			// console.log('updateWaypoints');
			let url = URL_GETPOINTS;
			if (waypoints.length > 0)  url += '?starting=' + waypoints[waypoints.length-1]['uid'];
			getJSON(url,  function(err, data) {
				if (err != null || data == null) {
					alert('Could not update data!');
					console.error(err);
					return;
				}
				if (data.length === 0) // no new data
					return;

				// Preprocess received data
				let waypoints_upd = data.sort(function(a, b) { return a.uid - b.uid}); // Sort ascending
				let coords_upd = waypoints2coords(waypoints_upd); // prepare lon/lat array

				// Concatenate with already existing data
				waypoints = waypoints.concat(waypoints_upd);
				coords = coords.concat(coords_upd);

				// Update track
				trackLine.setCoordinates(coords);
				trackLine.applyTransform(projectFunction);

				// Update marker
				markerPoint.setCoordinates(ol.proj.fromLonLat(coords[coords.length-1]));

				// Center map on track
				if (!waypoints.length || centerTrack)
					map.getView().fit(trackLine, {padding: [100, 100, 100, 100]});

				// Update info on page
				if (waypoints.length) {
					let lwp = waypoints[waypoints.length - 1]; // last waypoint
					// Update last_update
					if (lwp.timestamp_log)  time_at_marker_obj.innerText = lwp.timestamp_log;
					else if (lwp.timestamp_server)  time_at_marker_obj.innerText = lwp.timestamp_server + ' (request time)';
					else time_at_marker_obj.innerText = "unknown";
					// Update current_speed
					if (lwp.speed)  speed_at_marker_obj.innerText = Number(parseFloat(lwp.speed) * 3.6).toFixed(1) + " km/h";
					else speed_at_marker_obj.innerText = "unknown";
				}

				// Update last_update info
				last_refresh_obj.innerText = getFormattedDate();
			});
		};
		updateWaypoints(true); // initial update with full track

		// onClick for [update] button
		document.getElementById('update_btn').addEventListener('click', function(e) {
			updateWaypoints();
			setUpdateInterval();
		});

		var map = new ol.Map({
			target: 'map',
			layers: [
				new ol.layer.Tile({
					name: 'Tile',
					source: new ol.source.OSM()
				}),
				new ol.layer.Vector({
					name: 'Track',
					source: sourceTrack,
					style: styleTrack
				}),
				new ol.layer.Vector({
					name: 'Marker',
					source: sourceMarker,
					style: styleMarker
				})
			],
			view: new ol.View({
				center: ol.proj.fromLonLat([37.41, 8.82]),
				zoom: 4
			})
		});

		var refresh_interval_obj = document.getElementById('refresh_interval');
		var time_at_marker_obj = document.getElementById('time_at_marker');
		var speed_at_marker_obj = document.getElementById('speed_at_marker');
		var last_refresh_obj = document.getElementById('last_refresh');

		var refresh_interval = parseInt(refresh_interval_obj.options[refresh_interval_obj.selectedIndex].value);
		var refresh_interval_id = null;
		refresh_interval_obj.onchange = function() {
			// console.log('onchange');
			refresh_interval = parseInt(refresh_interval_obj.options[refresh_interval_obj.selectedIndex].value);
			setUpdateInterval();
		};
		var setUpdateInterval = function() {
			// console.log('setUpdateInterval: ' + refresh_interval);
			if (refresh_interval_id)  clearInterval(refresh_interval_id);
			if (refresh_interval > 0) {
				refresh_interval_id = window.setInterval(updateWaypoints, refresh_interval);
			}
		};
		setUpdateInterval();
	</script>
</body>
</html>